#!/usr/bin/env bash
# claude-recall - Claude Recall TUI wrapper
#
# The Python CLI has been replaced by Go binaries for better performance.
# This wrapper handles TUI (watch) commands via Python and delegates
# all other commands to the Go 'recall' binary.
#
# Usage:
#   claude-recall              # Launch TUI (default)
#   claude-recall watch        # Launch TUI explicitly
#   claude-recall --summary    # One-shot text summary
#   claude-recall --tail       # Colorized log tail
#   claude-recall -p project   # Filter to specific project
#
# For CLI commands, use the Go binary directly:
#   recall list                # List lessons
#   recall handoff list        # List handoffs
#   recall inject 5            # Inject top 5 lessons

set -euo pipefail

# Find the claude-recall installation
# Follow symlinks to get the real script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Check if we're in dev mode (running from repo)
if [[ -f "$SCRIPT_DIR/../core/tui_cli.py" ]]; then
    RECALL_DIR="$SCRIPT_DIR/.."
    TUI_PATH="$RECALL_DIR/core/tui_cli.py"
else
    # Find plugin in cache (versioned directory)
    PLUGIN_CACHE="$HOME/.claude/plugins/cache/claude-recall/claude-recall"
    if [[ -d "$PLUGIN_CACHE" ]]; then
        # Get latest version directory
        LATEST_VERSION=$(ls -1 "$PLUGIN_CACHE" 2>/dev/null | sort -V | tail -1)
        if [[ -n "$LATEST_VERSION" && -f "$PLUGIN_CACHE/$LATEST_VERSION/core/tui_cli.py" ]]; then
            RECALL_DIR="$PLUGIN_CACHE/$LATEST_VERSION"
            TUI_PATH="$RECALL_DIR/core/tui_cli.py"
        fi
    fi
fi

# Fallback to legacy locations if not found
if [[ -z "${TUI_PATH:-}" ]]; then
    if [[ -f "$HOME/.claude/plugins/claude-recall/core/tui_cli.py" ]]; then
        RECALL_DIR="$HOME/.claude/plugins/claude-recall"
        TUI_PATH="$RECALL_DIR/core/tui_cli.py"
    elif [[ -f "$HOME/.config/claude-recall/core/tui_cli.py" ]]; then
        RECALL_DIR="$HOME/.config/claude-recall"
        TUI_PATH="$RECALL_DIR/core/tui_cli.py"
    else
        echo "Error: Cannot find claude-recall installation" >&2
        exit 1
    fi
fi

# Use venv if available, otherwise system python
if [[ -f "$RECALL_DIR/.venv/bin/python3" ]]; then
    PYTHON="$RECALL_DIR/.venv/bin/python3"
else
    PYTHON="python3"
fi

# Commands that should go to the Go binary (not TUI)
GO_COMMANDS=(add add-ai cite inject list search show decay edit delete remove promote handoff approach session debug config inject-combined score-relevance stop-hook-batch)

# Check if first arg is a known Go command
if [[ $# -gt 0 ]]; then
    for cmd in "${GO_COMMANDS[@]}"; do
        if [[ "$1" == "$cmd" ]]; then
            # Delegate to Go binary
            GO_RECALL="${RECALL_DIR}/go/bin/recall"
            if [[ ! -x "$GO_RECALL" ]]; then
                GO_RECALL="$HOME/.config/claude-recall/go/bin/recall"
            fi
            if [[ ! -x "$GO_RECALL" ]]; then
                GO_RECALL="$HOME/.local/bin/recall"
            fi
            if [[ -x "$GO_RECALL" ]]; then
                exec "$GO_RECALL" "$@"
            else
                echo "Error: Go CLI binary not found. Install with:" >&2
                echo "  cd claude-recall && ./install.sh" >&2
                exit 1
            fi
        fi
    done
fi

# All other commands go to Python TUI
# Default to watch mode if no subcommand
if [[ $# -eq 0 ]]; then
    CMD_ARGS=("watch")
elif [[ "$1" == "watch" ]]; then
    CMD_ARGS=("$@")
else
    # Assume watch with options (e.g., -p, --summary, --tail)
    CMD_ARGS=("watch" "$@")
fi

# Check for textual (required for full TUI mode)
NEED_TEXTUAL=true
for arg in "${CMD_ARGS[@]}"; do
    if [[ "$arg" == "--summary" || "$arg" == "--tail" ]]; then
        NEED_TEXTUAL=false
        break
    fi
done

if $NEED_TEXTUAL && ! "$PYTHON" -c "import textual" 2>/dev/null; then
    echo "TUI mode requires textual. Install with:"
    echo "  pip install textual textual-plotext"
    echo ""
    echo "Or use --summary or --tail for text-only modes."
    exit 1
fi

exec "$PYTHON" "$TUI_PATH" "${CMD_ARGS[@]}"
