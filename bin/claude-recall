#!/usr/bin/env bash
# claude-recall - Claude Recall CLI and TUI
#
# Usage:
#   claude-recall              # Launch TUI (default)
#   claude-recall watch        # Launch TUI explicitly
#   claude-recall inject 5     # Inject top 5 lessons
#   claude-recall --summary    # One-shot text summary
#   claude-recall --tail       # Colorized log tail
#   claude-recall -p project   # Filter to specific project

set -euo pipefail

# Find the claude-recall installation
# Follow symlinks to get the real script location
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Check if we're in dev mode (running from repo)
if [[ -f "$SCRIPT_DIR/../core/cli.py" ]]; then
    RECALL_DIR="$SCRIPT_DIR/.."
    CLI_PATH="$RECALL_DIR/core/cli.py"
else
    # Find plugin in cache (versioned directory)
    PLUGIN_CACHE="$HOME/.claude/plugins/cache/claude-recall/claude-recall"
    if [[ -d "$PLUGIN_CACHE" ]]; then
        # Get latest version directory
        LATEST_VERSION=$(ls -1 "$PLUGIN_CACHE" 2>/dev/null | sort -V | tail -1)
        if [[ -n "$LATEST_VERSION" && -f "$PLUGIN_CACHE/$LATEST_VERSION/core/cli.py" ]]; then
            RECALL_DIR="$PLUGIN_CACHE/$LATEST_VERSION"
            CLI_PATH="$RECALL_DIR/core/cli.py"
        fi
    fi
fi

# Fallback to legacy locations if not found
if [[ -z "${CLI_PATH:-}" ]]; then
    if [[ -f "$HOME/.claude/plugins/claude-recall/core/cli.py" ]]; then
        RECALL_DIR="$HOME/.claude/plugins/claude-recall"
        CLI_PATH="$RECALL_DIR/core/cli.py"
    elif [[ -f "$HOME/.config/claude-recall/core/cli.py" ]]; then
        RECALL_DIR="$HOME/.config/claude-recall"
        CLI_PATH="$RECALL_DIR/core/cli.py"
    elif [[ -f "$HOME/.config/claude-recall/cli.py" ]]; then
        RECALL_DIR="$HOME/.config/claude-recall"
        CLI_PATH="$RECALL_DIR/cli.py"
    else
        echo "Error: Cannot find claude-recall installation" >&2
        exit 1
    fi
fi

# Use venv if available, otherwise system python
if [[ -f "$RECALL_DIR/.venv/bin/python3" ]]; then
    PYTHON="$RECALL_DIR/.venv/bin/python3"
else
    PYTHON="python3"
fi

# Check for textual (required for TUI mode)
if [[ "${1:-}" != "--summary" && "${1:-}" != "--tail" ]]; then
    if ! "$PYTHON" -c "import textual" 2>/dev/null; then
        echo "TUI mode requires textual. Install with:"
        echo "  pip install textual textual-plotext"
        echo ""
        echo "Or use --summary or --tail for text-only modes."
        exit 1
    fi
fi

exec "$PYTHON" "$CLI_PATH" watch "$@"
